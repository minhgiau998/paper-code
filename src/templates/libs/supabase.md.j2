# Supabase Documentation

> **Purpose:** The Open Source Firebase alternative. Provides Database (Postgres), Auth, Realtime, Storage, and Edge Functions.

## üì¶ Installation

{% if tech_stack | default("") and "Next.js" in tech_stack %}
### Next.js (App Router)
We use the modern **SSR** package to handle cookies securely in Server Components.

```bash
npm install @supabase/supabase-js @supabase/ssr
```

{% elif tech_stack | default("") and "Nuxt" in tech_stack %}
### Nuxt 3
We use the official Nuxt module.

```bash
npm install @nuxtjs/supabase
```

{% else %}
### Standard (React / Vue / Node.js)
```bash
npm install @supabase/supabase-js
```
{% endif %}

## üõ†Ô∏è Configuration & Typing (Critical)

### 1. Generate Types
**Strategy:** Never manually type your database rows. Let the CLI do it.
**Prerequisite:** You must have the [Supabase CLI](https://supabase.com/docs/guides/cli) installed.

Run this command whenever you change your DB Schema:
```bash
npx supabase gen types typescript --project-id "your-project-id" > src/types/supabase.ts
```

### 2. Client Initialization

{% if tech_stack | default("") and "Next.js" in tech_stack %}
In Next.js App Router, we need two clients: one for the **Browser** and one for the **Server** (to handle cookies).

**File:** `src/utils/supabase/client.ts` (Browser Client)
```typescript
import { createBrowserClient } from '@supabase/ssr'
import { Database } from '@/types/supabase'

export function createClient() {
  return createBrowserClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}
```

**File:** `src/utils/supabase/server.ts` (Server Client)
```typescript
import { createServerClient, type CookieOptions } from '@supabase/ssr'
import { cookies } from 'next/headers'
import { Database } from '@/types/supabase'

export function createClient() {
  const cookieStore = cookies()

  return createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value
        },
        // Set/Remove needed for Server Actions/Route Handlers
        set(name: string, value: string, options: CookieOptions) {
          try { cookieStore.set({ name, value, ...options }) } catch {}
        },
        remove(name: string, options: CookieOptions) {
          try { cookieStore.set({ name, value: '', ...options }) } catch {}
        },
      },
    }
  )
}
```

{% elif "Nuxt" in tech_stack %}
**File:** `nuxt.config.ts`

```typescript
export default defineNuxtConfig({
  modules: ['@nuxtjs/supabase'],
  supabase: {
    redirect: false, // Handle redirection manually via Middleware
  }
})
```

{% else %}
**File:** `src/lib/supabase.ts` (Singleton)

```typescript
import { createClient } from '@supabase/supabase-js'
import { Database } from '@/types/supabase'

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY

export const supabase = createClient<Database>(supabaseUrl, supabaseAnonKey)
```
{% endif %}

## üíª Usage Patterns

### 1. Data Fetching (Typed)

**Rule:** Always pass the `<Database>` generic to the client. This gives you autocomplete for table names and columns.

```typescript
{% if tech_stack | default("") and "Next.js" in tech_stack %}
// Inside a Server Component
import { createClient } from '@/utils/supabase/server'

export default async function Page() {
  const supabase = createClient()
  const { data: todos } = await supabase.from('todos').select('*')
  // 'todos' is strictly typed!
}
{% else %}
import { supabase } from '@/lib/supabase'

const fetchTodos = async () => {
  const { data, error } = await supabase
    .from('todos')
    .select('id, title, is_complete') // Select specific fields
    .eq('is_complete', false)
    
  if (error) console.error(error)
  return data
}
{% endif %}
```

### 2. Authentication

```typescript
const signIn = async () => {
  const { error } = await supabase.auth.signInWithOAuth({
    provider: 'github',
    options: {
      redirectTo: `${window.location.origin}/auth/callback`
    }
  })
}
```

## üõ°Ô∏è Security Rules (RLS)

### 1. Row Level Security (RLS) is Mandatory
**Critical Rule:** Never turn off RLS on public tables.
- Since Supabase allows calling the DB directly from the client (Browser), **RLS** is your only firewall.
- **Bad:** `create policy "Enable access to all users" ...`
- **Good:** `create policy "Users can see their own data" using (auth.uid() = user_id);`

### 2. Service Role Key
**Rule:** NEVER use `SUPABASE_SERVICE_ROLE_KEY` on the client side.
- It bypasses RLS. Only use it in **Edge Functions** or protected **API Routes**.

## üö´ Anti-Patterns to Avoid

1.  **Over-fetching:**
    *   Avoid `.select('*')` on tables with huge JSONB columns or text blobs unless necessary. Specify columns: `.select('id, name')`.

2.  **Filtering in JS:**
    *   **Bad:** Fetching 10,000 rows and filtering with `data.filter(...)`.
    *   **Good:** Use Postgres filters: `.eq()`, `.gt()`, `.textSearch()`. Let the DB do the work.

3.  **Database logic in Client:**
    *   Avoid complex multi-step transactions on the client (latency). Move complex logic to **Postgres Functions (RPC)** or **Edge Functions**.
    *   Call via: `supabase.rpc('function_name', { params })`.

## üìù Environment Variables

Ensure your `.env` is set correctly.

```bash
# Public (Safe to expose to browser)
NEXT_PUBLIC_SUPABASE_URL=https://xyz.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...

# Private (Server Only - Dangerous)
SUPABASE_SERVICE_ROLE_KEY=eyJ...
```